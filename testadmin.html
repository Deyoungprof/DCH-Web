<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Deyoungprof Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      font-family: 'Poppins', system-ui, sans-serif;
    }
    .tab-active {
      background: rgba(255,107,0,0.1);
      border-color: #FF6B00 !important;
      color: #FF6B00;
    }
    .loading-spinner {
      border: 2px solid rgba(255,107,0,0.1);
      border-top-color: #FF6B00;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0B0F19;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .toast.success { border-left: 3px solid #10B981; }
    .toast.error { border-left: 3px solid #EF4444; }
    .toast.info { border-left: 3px solid #3B82F6; }
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .upload-progress {
      height: 4px;
      background: rgba(255,107,0,0.2);
      border-radius: 2px;
      overflow: hidden;
    }
    .upload-progress-bar {
      height: 100%;
      background: #FF6B00;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body class="bg-[#0A0F1C] text-white/90">

  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="inline-flex items-center gap-3 mb-4">
          <div class="h-12 w-12 rounded-md border border-white/10 bg-white/5 grid place-items-center">
            <span class="text-white font-medium">DP</span>
          </div>
          <div class="text-left">
            <div class="text-lg text-white">Deyoungprof</div>
            <div class="text-sm text-white/50">Admin Panel</div>
          </div>
        </div>
      </div>
      
      <div class="rounded-xl border border-white/10 bg-white/5 p-6">
        <h2 class="text-xl font-semibold mb-6">Sign In</h2>
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm text-white/60 mb-2">Email</label>
            <input type="email" id="loginEmail" required class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
          </div>
          <div>
            <label class="block text-sm text-white/60 mb-2">Password</label>
            <input type="password" id="loginPassword" required class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
          </div>
          <button type="submit" id="loginBtn" class="w-full rounded-md bg-[#FF6B00] px-4 py-2 text-sm text-white hover:bg-[#ff7b1b] flex items-center justify-center gap-2">
            <span>Sign In</span>
          </button>
        </form>
        <div id="loginError" class="mt-4 text-sm text-red-400 hidden"></div>
      </div>
    </div>
  </div>

  <!-- Setup Wizard -->
  <div id="setupWizard" class="min-h-screen flex items-center justify-center p-4 hidden">
    <div class="w-full max-w-2xl">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-semibold mb-2">Welcome to Deyoungprof Admin</h1>
        <p class="text-white/60">Let's set up your admin account and initialize the database</p>
      </div>
      
      <div class="rounded-xl border border-white/10 bg-white/5 p-6">
        <form id="setupForm" class="space-y-6">
          <div>
            <label class="block text-sm text-white/60 mb-2">Admin Email</label>
            <input type="email" id="setupEmail" required class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
          </div>
          <div>
            <label class="block text-sm text-white/60 mb-2">Admin Password</label>
            <input type="password" id="setupPassword" required minlength="6" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
            <p class="text-xs text-white/40 mt-1">Minimum 6 characters</p>
          </div>
          <button type="submit" id="setupBtn" class="w-full rounded-md bg-[#FF6B00] px-4 py-3 text-sm text-white hover:bg-[#ff7b1b] flex items-center justify-center gap-2">
            <span>Initialize Database & Create Account</span>
          </button>
        </form>
        <div id="setupStatus" class="mt-4 text-sm text-white/60 hidden"></div>
      </div>
    </div>
  </div>

  <!-- Main Admin Dashboard -->
  <div id="adminDashboard" class="hidden">
    <header class="border-b border-white/10 bg-[#0A0F1C]/80 backdrop-blur-lg sticky top-0 z-40">
      <div class="mx-auto max-w-7xl px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-md border border-white/10 bg-white/5 grid place-items-center">
              <span class="text-white font-medium">DP</span>
            </div>
            <div>
              <div class="text-sm text-white">Deyoungprof Admin</div>
              <div class="text-xs text-white/50" id="userEmail"></div>
            </div>
          </div>
          <button id="logoutBtn" class="inline-flex items-center gap-2 rounded-md border border-white/10 px-3 py-2 text-sm hover:bg-white/5">
            <i data-lucide="log-out" class="h-4 w-4"></i>
            Logout
          </button>
        </div>
      </div>
    </header>

    <div class="border-b border-white/10 bg-[#0A0F1C]/50">
      <div class="mx-auto max-w-7xl px-4">
        <div class="flex gap-2 overflow-x-auto">
          <button class="tab tab-active px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="h-4 w-4 inline mr-2"></i>Dashboard
          </button>
          <button class="tab px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="portfolio">
            <i data-lucide="images" class="h-4 w-4 inline mr-2"></i>Portfolio
          </button>
          <button class="tab px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="carousel">
            <i data-lucide="monitor" class="h-4 w-4 inline mr-2"></i>Carousel
          </button>
          <button class="tab px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="services">
            <i data-lucide="briefcase" class="h-4 w-4 inline mr-2"></i>Services
          </button>
          <button class="tab px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="settings">
            <i data-lucide="settings" class="h-4 w-4 inline mr-2"></i>Settings
          </button>
          <button class="tab px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="highlights">
            <i data-lucide="zap" class="h-4 w-4 inline mr-2"></i>Hero Highlights
          </button>
          <button class="tab px-4 py-3 text-sm border-b-2 border-transparent hover:border-white/20 whitespace-nowrap" data-tab="team">
  <i data-lucide="users" class="h-4 w-4 inline mr-2"></i>Team Members
</button>
        </div>
      </div>
      <div id="teamTab" class="tab-content hidden">
  <div class="mx-auto max-w-7xl">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-semibold">Team Members Manager</h2>
        <p class="text-sm text-white/60 mt-1">Manage your creative team profiles</p>
      </div>
      <button id="addTeamMemberBtn" class="inline-flex items-center gap-2 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
        <i data-lucide="plus" class="h-4 w-4"></i>Add Team Member
      </button>
    </div>
    <div id="teamMembersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</div>
    </div>

    <div class="mx-auto max-w-7xl px-4 py-8">
      <div id="dashboardTab" class="tab-content">
        <h2 class="text-2xl font-semibold mb-6">Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-white/60">Portfolio Items</p>
                <p class="text-3xl font-semibold mt-2" id="portfolioCount">0</p>
              </div>
              <i data-lucide="images" class="h-8 w-8 text-[#FF6B00]"></i>
            </div>
          </div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-white/60">Carousel Slides</p>
                <p class="text-3xl font-semibold mt-2" id="carouselCount">0</p>
              </div>
              <i data-lucide="monitor" class="h-8 w-8 text-[#FF6B00]"></i>
            </div>
          </div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-white/60">Active Services</p>
                <p class="text-3xl font-semibold mt-2" id="servicesCount">0</p>
              </div>
              <i data-lucide="briefcase" class="h-8 w-8 text-[#FF6B00]"></i>
            </div>
          </div>
        </div>
      </div>

      <div id="portfolioTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-semibold">Portfolio Manager</h2>
          <button id="addPortfolioBtn" class="inline-flex items-center gap-2 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
            <i data-lucide="plus" class="h-4 w-4"></i>Add Item
          </button>
        </div>

        <div class="flex gap-2 mb-6 flex-wrap">
          <button class="category-filter bg-[#FF6B00] text-white px-3 py-2 text-sm rounded-md" data-category="all">All</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="birthday">Birthday</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="academic">Academic</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="wedding">Wedding</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="business">Business</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="movie">Movie</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="church">Church</button>
          <button class="category-filter px-3 py-2 text-sm rounded-md border border-white/10 hover:bg-white/5" data-category="brand">Brand</button>
        </div>

        <div id="portfolioList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <div id="carouselTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-semibold">Carousel Manager</h2>
          <button id="addCarouselBtn" class="inline-flex items-center gap-2 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
            <i data-lucide="plus" class="h-4 w-4"></i>Add Slide
          </button>
        </div>
        <div id="carouselList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <div id="servicesTab" class="tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-semibold">Services Manager</h2>
          <button id="addServiceBtn" class="inline-flex items-center gap-2 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
            <i data-lucide="plus" class="h-4 w-4"></i>Add Service
          </button>
        </div>
        <div id="servicesList" class="space-y-4"></div>
      </div>

      <div id="settingsTab" class="tab-content hidden">
  <h2 class="text-2xl font-semibold mb-6">Site Settings</h2>
  <form id="settingsForm" class="space-y-6">
    
    <!-- NEW SECTION: LOGOS -->
    <div class="rounded-xl border border-white/10 bg-white/5 p-6">
      <h3 class="text-lg font-semibold mb-4">Branding & Logos</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-white/60 mb-2">Main Logo (Header/Footer)</label>
          <input type="file" id="settingsLogoMain" accept="image/*" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
          <p class="text-xs text-white/40 mt-1">PNG/SVG recommended, max 5MB. Square format works best.</p>
          <div id="logoMainPreview"></div>
        </div>
        
        <div>
  <label class="block text-sm text-white/60 mb-2">Location Image (Contact Section)</label>
  <input type="file" id="settingsLocationImage" accept="image/*" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
  <p class="text-xs text-white/40 mt-1">JPG/PNG recommended, max 5MB. Landscape format works best.</p>
  <div id="locationImagePreview"></div>
</div>
      </div>
    </div>
    
    <div class="rounded-xl border border-white/10 bg-white/5 p-6">
      <h3 class="text-lg font-semibold mb-4">Contact Information</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-white/60 mb-2">Email</label>
                <input type="email" id="settingsEmail" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Phone (WhatsApp)</label>
                <input type="text" id="settingsPhone" placeholder="2348147732687" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Address</label>
                <textarea id="settingsAddress" rows="3" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]"></textarea>
              </div>
              <div>
  <label class="block text-sm text-white/60 mb-2">Location Display Text</label>
  <input type="text" id="settingsLocationText" placeholder="Agbara, Badagry" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
  <p class="text-xs text-white/40 mt-1">Short location text shown on contact map</p>
</div>
            </div>
          </div>

          <div class="rounded-xl border border-white/10 bg-white/5 p-6">
            <h3 class="text-lg font-semibold mb-4">Social Media</h3>
            <div>
              <label class="block text-sm text-white/60 mb-2">Instagram URL</label>
              <input type="url" id="settingsInstagram" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
            </div>
          </div>

<div class="rounded-xl border border-white/10 bg-white/5 p-6">
  <h3 class="text-lg font-semibold mb-4">Team Settings</h3>
  <div class="flex items-center justify-between">
    <div>
      <label class="block text-sm text-white/80 mb-1">Show "Join Our Team" Card</label>
      <p class="text-xs text-white/40">Display a recruitment placeholder on the website</p>
    </div>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="settingsShowJoinTeam" class="sr-only peer">
      <div class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#FF6B00]"></div>
    </label>
  </div>
</div>

          <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
            <i data-lucide="save" class="h-4 w-4"></i>Save Settings
          </button>

          <div class="mt-8 pt-8 border-t border-white/10">
            <h3 class="text-lg font-semibold mb-3">Migration Tools</h3>
            <p class="text-sm text-white/60 mb-4">One-time content migration utilities for initial setup.</p>
            <a href="migrate.html" class="inline-flex items-center gap-2 rounded-md border border-white/10 bg-white/5 px-4 py-2 text-sm hover:bg-white/10">
              <i data-lucide="database" class="h-4 w-4"></i>
              Open Migration Hub
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

<div id="highlightsTab" class="tab-content hidden">
        <div class="mx-auto max-w-7xl">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-semibold">Hero Highlights Manager</h2>
              <p class="text-sm text-white/60 mt-1">Manage the 3 highlight cards in your hero section (max 3)</p>
            </div>
            <button id="addHighlightBtn" class="inline-flex items-center gap-2 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
              <i data-lucide="plus" class="h-4 w-4"></i>Add Highlight
            </button>
          </div>
          <div id="highlightsList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>
      </div>

  <div id="modalContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, query, orderBy, where, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVhKuw3k3gmAlJMjMzXtRlc9FAcT_-ks8",
      authDomain: "deyoungprof-creative-hub.firebaseapp.com",
      projectId: "deyoungprof-creative-hub",
      storageBucket: "deyoungprof-creative-hub.firebasestorage.app",
      messagingSenderId: "753963504321",
      appId: "1:753963504321:web:ab4f16cace407e2c5b3a40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let currentCategory = 'all';

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info';
      toast.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${iconName}" class="h-4 w-4"></i><span class="text-sm">${message}</span></div>`;
      document.body.appendChild(toast);
      if (window.lucide) window.lucide.createIcons();
      setTimeout(() => toast.remove(), 5000);
      if (type === 'error') console.error('Error Toast:', message);
    }

    function setLoading(element, isLoading) {
      if (isLoading) {
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        element.appendChild(spinner);
        element.disabled = true;
      } else {
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.remove();
        element.disabled = false;
      }
    }

    function initIcons() {
      setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
    }

    function validateImage(file) {
      const errors = [];
      if (!file) {
        errors.push('Please select an image');
        return errors;
      }
      if (!file.type.startsWith('image/')) {
        errors.push('File must be an image (JPG, PNG, GIF, etc.)');
      }
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        errors.push(`Image must be less than 5MB (current: ${(file.size / 1024 / 1024).toFixed(2)}MB)`);
      }
      return new Promise((resolve) => {
        if (errors.length > 0) {
          resolve(errors);
          return;
        }
        const img = new Image();
        img.onload = function() {
          if (this.width < 200 || this.height < 200) {
            errors.push('Image should be at least 200x200 pixels');
          }
          resolve(errors);
        };
        img.onerror = function() {
          errors.push('Invalid image file');
          resolve(errors);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function createImagePreview(file, containerId) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById(containerId);
        if (preview) {
          preview.innerHTML = `
            <div class="mt-3">
              <p class="text-xs text-white/60 mb-2">Preview:</p>
              <img src="${e.target.result}" class="image-preview" alt="Preview">
              <p class="text-xs text-white/40 mt-2">${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
            </div>
          `;
        }
      };
      reader.readAsDataURL(file);
    }

    async function uploadImageWithRetry(file, path, maxRetries = 3) {
      let lastError;
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          console.log(`Upload attempt ${attempt}/${maxRetries} for ${path}`);
          const storageRef = ref(storage, path);
          const uploadTask = uploadBytesResumable(storageRef, file);
          return await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                updateUploadProgress(progress);
                console.log('Upload progress:', progress.toFixed(2) + '%');
              },
              (error) => {
                console.error(`Upload error on attempt ${attempt}:`, error);
                reject(error);
              },
              async () => {
                try {
                  const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                  console.log('Upload successful:', downloadURL);
                  resolve(downloadURL);
                } catch (error) {
                  reject(error);
                }
              }
            );
          });
        } catch (error) {
          lastError = error;
          console.error(`Attempt ${attempt} failed:`, error);
          if (attempt < maxRetries) {
            showToast(`Upload failed, retrying... (${attempt}/${maxRetries})`, 'info');
            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
          }
        }
      }
      throw lastError;
    }

    function updateUploadProgress(progress) {
      const progressBar = document.getElementById('uploadProgress');
      if (progressBar) {
        const bar = progressBar.querySelector('.upload-progress-bar');
        if (bar) bar.style.width = progress + '%';
      }
    }

    function createProgressBar() {
      return `
        <div id="uploadProgress" class="upload-progress mt-3">
          <div class="upload-progress-bar" style="width: 0%"></div>
        </div>
        <p class="text-xs text-white/60 mt-2">Uploading...</p>
      `;
    }

    async function checkSetupStatus() {
      try {
        const settingsDoc = await getDoc(doc(db, 'siteSettings', 'main'));
        return settingsDoc.exists();
      } catch (error) {
        console.error('Setup check error:', error);
        return false;
      }
    }

    async function initializeDatabase() {
      try {
        await setDoc(doc(db, 'siteSettings', 'main'), {
          contact: { email: 'stephen@bi-okoto.com', phone: '2348147732687', address: '4, Mbere Close, Morogbo Bus Stop, Agbara, Badagry, Lagos' },
          social: { whatsapp: '2348147732687', instagram: '#' },
          logos: { main: '', portrait: '' },
          createdAt: serverTimestamp()
        });
        const services = [
          { name: 'Birthday Celebration Designs', icon: 'sparkles', price: '₦5,000', description: 'Eye-catching and vibrant graphics.', active: true, order: 1 },
          { name: 'Academic Project Designs', icon: 'book-open', price: 'avg. ₦20,000', description: 'Professional academic covers.', active: true, order: 2 },
          { name: 'Wedding Designs', icon: 'heart', price: '₦5,000', description: 'Elegant wedding designs.', active: true, order: 3 },
          { name: 'Business Social Media Flyers', icon: 'megaphone', price: '₦4,000', description: 'Modern business flyers.', active: true, order: 4 },
          { name: 'Movie Poster Designs', icon: 'clapperboard', price: '₦5,000', description: 'Bold cinematic visuals.', active: true, order: 5 },
          { name: 'Church Social Media Designs', icon: 'church', price: '₦3,000', description: 'Faith-driven designs.', active: true, order: 6 },
          { name: 'Brand Identity', icon: 'asterisk', price: '₦5,000', description: 'Memorable logos.', active: true, order: 7 },
          { name: 'Brand Designs', icon: 'palette', price: 'avg. ₦15,000', description: 'Complete brand kits.', active: true, order: 8 }
        ];
        for (const service of services) await addDoc(collection(db, 'services'), service);
        return true;
      } catch (error) {
        console.error('Database initialization error:', error);
        showToast('Database init failed: ' + error.message, 'error');
        return false;
      }
    }

    document.getElementById('setupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('setupBtn');
      const statusEl = document.getElementById('setupStatus');
      setLoading(btn, true);
      statusEl.classList.remove('hidden');
      statusEl.textContent = 'Creating account...';
      try {
        await createUserWithEmailAndPassword(auth, document.getElementById('setupEmail').value, document.getElementById('setupPassword').value);
        statusEl.textContent = 'Initializing database...';
        await initializeDatabase();
        statusEl.textContent = 'Setup complete!';
        showToast('Setup completed successfully!', 'success');
      } catch (error) {
        console.error('Setup error:', error);
        statusEl.textContent = `Error: ${error.message}`;
        showToast(error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      const errorEl = document.getElementById('loginError');
      setLoading(btn, true);
      errorEl.classList.add('hidden');
      try {
        await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
        showToast('Login successful!', 'success');
      } catch (error) {
        console.error('Login error:', error);
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
        showToast('Login failed', 'error');
      } finally {
        setLoading(btn, false);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      showToast('Logged out', 'success');
    });

    onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('setupWizard').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    await loadDashboard();
    initLogoPreviewListeners(); // Initialize logo preview listeners
    initIcons();
      } else {
        const isSetup = await checkSetupStatus();
        document.getElementById('loginScreen').classList.toggle('hidden', !isSetup);
        document.getElementById('setupWizard').classList.toggle('hidden', isSetup);
        document.getElementById('adminDashboard').classList.add('hidden');
        initIcons();
      }
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
        tab.classList.add('tab-active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`${tab.dataset.tab}Tab`).classList.remove('hidden');
        initIcons();
      });
    });

    async function loadDashboard() {
      try {
        const [portfolioSnap, carouselSnap, servicesSnap] = await Promise.all([
          getDocs(collection(db, 'portfolioItems')),
          getDocs(collection(db, 'carouselSlides')),
          getDocs(query(collection(db, 'services'), where('active', '==', true)))
        ]);
        document.getElementById('portfolioCount').textContent = portfolioSnap.size;
        document.getElementById('carouselCount').textContent = carouselSnap.size;
        document.getElementById('servicesCount').textContent = servicesSnap.size;
        await Promise.all([loadPortfolioItems(), loadCarouselSlides(), loadServices(), loadSettings(), loadHeroHighlights(), loadTeamMembers()]);
        initIcons();
      } catch (error) {
        console.error('Dashboard load error:', error);
        showToast('Error loading dashboard', 'error');
      }
    }

    document.querySelectorAll('.category-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        currentCategory = btn.dataset.category;
        document.querySelectorAll('.category-filter').forEach(b => {
          b.classList.remove('bg-[#FF6B00]', 'text-white');
        });
        btn.classList.add('bg-[#FF6B00]', 'text-white');
        loadPortfolioItems();
      });
    });

    async function loadPortfolioItems() {
      const listEl = document.getElementById('portfolioList');
      listEl.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="loading-spinner"></div></div>';
      try {
        const q = query(collection(db, 'portfolioItems'), orderBy('order'));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          listEl.innerHTML = '<p class="text-white/60 col-span-full">No items yet</p>';
          return;
        }
        listEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (currentCategory === 'all' || data.category === currentCategory) {
            const card = document.createElement('div');
            card.className = 'rounded-xl border border-white/10 bg-white/5 overflow-hidden';
            card.innerHTML = `
              <div class="aspect-square bg-black/20 relative">
                <img src="${data.imageUrl}" alt="${data.title}" class="h-full w-full object-contain" loading="lazy">
              </div>
              <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-white/60">${data.categoryDisplay}</span>
                  <span class="text-sm text-white/80">${data.price}</span>
                </div>
                <h3 class="text-sm font-medium text-white mb-2">${data.title}</h3>
                <div class="flex gap-2">
                  <button class="edit-portfolio flex-1 rounded-md border border-white/10 px-3 py-2 text-xs hover:bg-white/5" data-id="${docSnap.id}">
                    <i data-lucide="edit" class="h-3 w-3 inline mr-1"></i>Edit
                  </button>
                  <button class="delete-portfolio flex-1 rounded-md border border-red-500/50 text-red-400 px-3 py-2 text-xs hover:bg-red-500/10" data-id="${docSnap.id}">
                    <i data-lucide="trash-2" class="h-3 w-3 inline mr-1"></i>Delete
                  </button>
                </div>
              </div>
            `;
            listEl.appendChild(card);
          }
        });
        document.querySelectorAll('.edit-portfolio').forEach(btn => {
          btn.addEventListener('click', async () => {
            const docSnap = await getDoc(doc(db, 'portfolioItems', btn.dataset.id));
            if (docSnap.exists()) showPortfolioModal(btn.dataset.id, docSnap.data());
          });
        });
        document.querySelectorAll('.delete-portfolio').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this item?')) {
              try {
                await deleteDoc(doc(db, 'portfolioItems', btn.dataset.id));
                showToast('Item deleted', 'success');
                loadPortfolioItems();
                loadDashboard();
              } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting item: ' + error.message, 'error');
              }
            }
          });
        });
        initIcons();
      } catch (error) {
        console.error('Portfolio load error:', error);
        showToast('Error loading portfolio', 'error');
        listEl.innerHTML = '<p class="text-red-400 col-span-full">Error loading items. Please refresh.</p>';
      }
    }

    async function loadCarouselSlides() {
      const listEl = document.getElementById('carouselList');
      listEl.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="loading-spinner"></div></div>';
      try {
        const q = query(collection(db, 'carouselSlides'), orderBy('order'));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          listEl.innerHTML = '<p class="text-white/60">No slides yet</p>';
          return;
        }
        listEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const card = document.createElement('div');
          card.className = 'rounded-xl border border-white/10 bg-white/5 overflow-hidden';
          card.innerHTML = `
            <div class="aspect-video bg-black/20 relative">
              <img src="${data.imageUrl}" alt="${data.title}" class="h-full w-full object-contain" loading="lazy">
            </div>
            <div class="p-4">
              <h3 class="text-sm font-medium text-white mb-2">${data.title}</h3>
              <p class="text-xs text-white/60 mb-3">${data.description}</p>
              <div class="flex gap-2">
                <button class="edit-carousel flex-1 rounded-md border border-white/10 px-3 py-2 text-xs hover:bg-white/5" data-id="${docSnap.id}">
                  <i data-lucide="edit" class="h-3 w-3 inline mr-1"></i>Edit
                </button>
                <button class="delete-carousel flex-1 rounded-md border border-red-500/50 text-red-400 px-3 py-2 text-xs hover:bg-red-500/10" data-id="${docSnap.id}">
                  <i data-lucide="trash-2" class="h-3 w-3 inline mr-1"></i>Delete
                </button>
              </div>
            </div>
          `;
          listEl.appendChild(card);
        });
        document.querySelectorAll('.edit-carousel').forEach(btn => {
          btn.addEventListener('click', async () => {
            const docSnap = await getDoc(doc(db, 'carouselSlides', btn.dataset.id));
            if (docSnap.exists()) showCarouselModal(btn.dataset.id, docSnap.data());
          });
        });
        document.querySelectorAll('.delete-carousel').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this slide?')) {
              try {
                await deleteDoc(doc(db, 'carouselSlides', btn.dataset.id));
                showToast('Slide deleted', 'success');
                loadCarouselSlides();
                loadDashboard();
              } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting slide: ' + error.message, 'error');
              }
            }
          });
        });
        initIcons();
      } catch (error) {
        console.error('Carousel load error:', error);
        showToast('Error loading carousel', 'error');
        listEl.innerHTML = '<p class="text-red-400">Error loading slides. Please refresh.</p>';
      }
    }

    async function loadServices() {
      const listEl = document.getElementById('servicesList');
      listEl.innerHTML = '<div class="flex justify-center py-8"><div class="loading-spinner"></div></div>';
      try {
        const q = query(collection(db, 'services'), orderBy('order'));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          listEl.innerHTML = '<p class="text-white/60">No services yet</p>';
          return;
        }
        listEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const card = document.createElement('div');
          card.className = 'rounded-xl border border-white/10 bg-white/5 p-4';
          card.innerHTML = `
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <i data-lucide="${data.icon}" class="h-5 w-5 text-[#FF6B00]"></i>
                  <h3 class="text-base font-semibold text-white">${data.name}</h3>
                  <span class="text-sm text-white/80">${data.price}</span>
                </div>
                <p class="text-sm text-white/60">${data.description}</p>
              </div>
              <div class="flex gap-2 ml-4">
                <button class="edit-service rounded-md border border-white/10 px-3 py-2 text-xs hover:bg-white/5" data-id="${docSnap.id}">
                  <i data-lucide="edit" class="h-3 w-3"></i>
                </button>
                <button class="delete-service rounded-md border border-red-500/50 text-red-400 px-3 py-2 text-xs hover:bg-red-500/10" data-id="${docSnap.id}">
                  <i data-lucide="trash-2" class="h-3 w-3"></i>
                </button>
              </div>
            </div>
          `;
          listEl.appendChild(card);
        });
        document.querySelectorAll('.edit-service').forEach(btn => {
          btn.addEventListener('click', async () => {
            const docSnap = await getDoc(doc(db, 'services', btn.dataset.id));
            if (docSnap.exists()) showServiceModal(btn.dataset.id, docSnap.data());
          });
        });
        document.querySelectorAll('.delete-service').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this service?')) {
              try {
                await deleteDoc(doc(db, 'services', btn.dataset.id));
                showToast('Service deleted', 'success');
                loadServices();
                loadDashboard();
              } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting service: ' + error.message, 'error');
              }
            }
          });
        });
        initIcons();
      } catch (error) {
        console.error('Services load error:', error);
        showToast('Error loading services', 'error');
        listEl.innerHTML = '<p class="text-red-400">Error loading services. Please refresh.</p>';
      }
    }

    async function loadSettings() {
  try {
    const settingsDoc = await getDoc(doc(db, 'siteSettings', 'main'));
    if (settingsDoc.exists()) {
      const data = settingsDoc.data();
      document.getElementById('settingsEmail').value = data.contact?.email || '';
      document.getElementById('settingsPhone').value = data.contact?.phone || '';
      document.getElementById('settingsAddress').value = data.contact?.address || '';
      document.getElementById('settingsLocationText').value = data.contact?.locationText || 'Agbara, Badagry';
      document.getElementById('settingsInstagram').value = data.social?.instagram || '';
      
      // Load team settings toggle
      document.getElementById('settingsShowJoinTeam').checked = data.teamSettings?.showJoinTeam || false;
      
      // Load existing logos if they exist
      if (data.logos?.main) {
        document.getElementById('logoMainPreview').innerHTML = `
          <div class="mt-3">
            <p class="text-xs text-white/60 mb-2">Current Logo:</p>
            <img src="${data.logos.main}" class="image-preview" alt="Current main logo">
            <p class="text-xs text-white/40 mt-2">Upload a new image to replace</p>
          </div>
        `;
      }
      
      // Load location image
      if (data.location?.imageUrl) {
        document.getElementById('locationImagePreview').innerHTML = `
          <div class="mt-3">
            <p class="text-xs text-white/60 mb-2">Current Location Image:</p>
            <img src="${data.location.imageUrl}" class="image-preview" alt="Current location image">
            <p class="text-xs text-white/40 mt-2">Upload a new image to replace</p>
          </div>
        `;
      }
    }
  } catch (error) {
    console.error('Settings load error:', error);
    showToast('Error loading settings', 'error');
  }
}

// Add file input listeners for logo previews (place this after loadSettings function)
function initLogoPreviewListeners() {
  document.getElementById('settingsLogoMain')?.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      const errors = await validateImage(file);
      if (errors.length > 0) {
        showToast(errors.join(', '), 'error');
        e.target.value = '';
        return;
      }
      createImagePreview(file, 'logoMainPreview');
    }
  });

  document.getElementById('settingsLocationImage')?.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      const errors = await validateImage(file);
      if (errors.length > 0) {
        showToast(errors.join(', '), 'error');
        e.target.value = '';
        return;
      }
      createImagePreview(file, 'locationImagePreview');
    }
  });
}

// Load hero highlights
    async function loadHeroHighlights() {
      const listEl = document.getElementById('highlightsList');
      listEl.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="loading-spinner"></div></div>';
      
      try {
        const q = query(collection(db, 'heroHighlights'), orderBy('order'));
        const snapshot = await getDocs(q);
        
        // Update "Add" button state
        const addBtn = document.getElementById('addHighlightBtn');
        if (snapshot.size >= 3) {
          addBtn.disabled = true;
          addBtn.classList.add('opacity-50', 'cursor-not-allowed');
          addBtn.innerHTML = '<i data-lucide="lock" class="h-4 w-4 mr-2"></i>Maximum 3 Highlights';
        } else {
          addBtn.disabled = false;
          addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          addBtn.innerHTML = '<i data-lucide="plus" class="h-4 w-4 mr-2"></i>Add Highlight';
        }
        
        if (snapshot.empty) {
          listEl.innerHTML = '<p class="text-white/60 col-span-full">No highlights yet. Add up to 3.</p>';
          if (window.lucide) window.lucide.createIcons();
          return;
        }

        listEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const card = document.createElement('div');
          card.className = 'rounded-xl border border-white/10 bg-white/5 p-5';
          card.innerHTML = `
            <div class="flex items-center gap-3 mb-3">
              <i data-lucide="${data.icon}" class="h-6 w-6 text-[#FF6B00]"></i>
              <h3 class="text-base font-semibold text-white">${data.title}</h3>
            </div>
            <p class="text-sm text-white/60 mb-4">${data.description}</p>
            <div class="flex gap-2">
              <button class="edit-highlight flex-1 rounded-md border border-white/10 px-3 py-2 text-xs hover:bg-white/5" data-id="${docSnap.id}">
                <i data-lucide="edit" class="h-3 w-3 inline mr-1"></i>Edit
              </button>
              <button class="delete-highlight flex-1 rounded-md border border-red-500/50 text-red-400 px-3 py-2 text-xs hover:bg-red-500/10" data-id="${docSnap.id}">
                <i data-lucide="trash-2" class="h-3 w-3 inline mr-1"></i>Delete
              </button>
            </div>
          `;
          listEl.appendChild(card);
        });

        document.querySelectorAll('.edit-highlight').forEach(btn => {
          btn.addEventListener('click', async () => {
            const docSnap = await getDoc(doc(db, 'heroHighlights', btn.dataset.id));
            if (docSnap.exists()) showHighlightModal(btn.dataset.id, docSnap.data());
          });
        });

        document.querySelectorAll('.delete-highlight').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Delete this highlight?')) {
              try {
                await deleteDoc(doc(db, 'heroHighlights', btn.dataset.id));
                showToast('Highlight deleted', 'success');
                loadHeroHighlights();
              } catch (error) {
                console.error('Delete error:', error);
                showToast('Error deleting highlight: ' + error.message, 'error');
              }
            }
          });
        });

        initIcons();
      } catch (error) {
        console.error('Highlights load error:', error);
        showToast('Error loading highlights', 'error');
        listEl.innerHTML = '<p class="text-red-400 col-span-full">Error loading highlights. Please refresh.</p>';
      }
    }

    document.getElementById('addHighlightBtn').addEventListener('click', () => showHighlightModal());

// Load team members
async function loadTeamMembers() {
  const listEl = document.getElementById('teamMembersList');
  listEl.innerHTML = '<div class="col-span-full flex justify-center py-8"><div class="loading-spinner"></div></div>';
  
  try {
    const q = query(collection(db, 'teamMembers'), orderBy('order'));
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
      listEl.innerHTML = '<p class="text-white/60 col-span-full">No team members yet. Add your first one!</p>';
      return;
    }

    listEl.innerHTML = '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const card = document.createElement('div');
      card.className = 'rounded-xl border border-white/10 bg-white/5 overflow-hidden';
      card.innerHTML = `
        <div class="aspect-[4/3] bg-black/20 relative">
          <img src="${data.imageUrl}" alt="${data.name}" class="h-full w-full object-cover" loading="lazy">
          ${data.isCEO ? '<div class="absolute top-2 right-2 bg-[#FF6B00] text-white text-xs px-2 py-1 rounded">CEO</div>' : ''}
        </div>
        <div class="p-4">
          <h3 class="text-base font-semibold text-white mb-1">${data.name}</h3>
          <p class="text-sm text-white/60 mb-2">${data.role}</p>
          <p class="text-xs text-white/50 mb-3 line-clamp-2">${data.bio}</p>
          <div class="flex gap-2">
            <button class="edit-team flex-1 rounded-md border border-white/10 px-3 py-2 text-xs hover:bg-white/5" data-id="${docSnap.id}">
              <i data-lucide="edit" class="h-3 w-3 inline mr-1"></i>Edit
            </button>
            <button class="delete-team flex-1 rounded-md border border-red-500/50 text-red-400 px-3 py-2 text-xs hover:bg-red-500/10" data-id="${docSnap.id}">
              <i data-lucide="trash-2" class="h-3 w-3 inline mr-1"></i>Delete
            </button>
          </div>
        </div>
      `;
      listEl.appendChild(card);
    });

    document.querySelectorAll('.edit-team').forEach(btn => {
      btn.addEventListener('click', async () => {
        const docSnap = await getDoc(doc(db, 'teamMembers', btn.dataset.id));
        if (docSnap.exists()) showTeamMemberModal(btn.dataset.id, docSnap.data());
      });
    });

    document.querySelectorAll('.delete-team').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (confirm('Delete this team member?')) {
          try {
            await deleteDoc(doc(db, 'teamMembers', btn.dataset.id));
            showToast('Team member deleted', 'success');
            loadTeamMembers();
          } catch (error) {
            console.error('Delete error:', error);
            showToast('Error deleting team member: ' + error.message, 'error');
          }
        }
      });
    });

    initIcons();
  } catch (error) {
    console.error('Team members load error:', error);
    showToast('Error loading team members', 'error');
    listEl.innerHTML = '<p class="text-red-400 col-span-full">Error loading team members. Please refresh.</p>';
  }
}

document.getElementById('addTeamMemberBtn').addEventListener('click', () => showTeamMemberModal());

function showTeamMemberModal(editId = null, editData = null) {
  const modal = `
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" id="teamMemberModal">
      <div class="w-full max-w-lg rounded-xl border border-white/10 bg-[#0B0F19] p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold">${editId ? 'Edit' : 'Add'} Team Member</h3>
          <button class="close-modal text-white/60 hover:text-white">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>
        <form id="teamMemberForm" class="space-y-4">
          <div>
            <label class="block text-sm text-white/60 mb-2">Full Name</label>
            <input type="text" id="tmName" required placeholder="Stephen Okoto" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
          </div>
          <div>
            <label class="block text-sm text-white/60 mb-2">Role/Title</label>
            <input type="text" id="tmRole" required placeholder="Founder & Creative Director" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
          </div>
          <div>
            <label class="block text-sm text-white/60 mb-2">Bio (2-3 sentences)</label>
            <textarea id="tmBio" required rows="3" placeholder="Brief description of expertise and vision..." class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]"></textarea>
          </div>
          <div>
            <label class="block text-sm text-white/60 mb-2">Profile Image ${editId ? '(leave empty to keep current)' : ''}</label>
            <input type="file" id="tmImage" accept="image/*" ${editId ? '' : 'required'} class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
            <p class="text-xs text-white/40 mt-1">Max 5MB. Portrait photo recommended (4:3 or square)</p>
            <div id="tmImagePreview"></div>
          </div>
          <div>
            <label class="block text-sm text-white/60 mb-2">Display Order</label>
            <input type="number" id="tmOrder" required min="1" value="1" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-[#FF6B00]">
            <p class="text-xs text-white/40 mt-1">Lower numbers appear first (1, 2, 3...)</p>
          </div>
          <div class="flex items-center justify-between rounded-lg border border-white/10 bg-white/5 p-4">
            <div>
              <label class="block text-sm text-white/80 mb-1">Mark as CEO/Founder</label>
              <p class="text-xs text-white/40">Show special badge on profile</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="tmIsCEO" class="sr-only peer">
              <div class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#FF6B00]"></div>
            </label>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="flex-1 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
              ${editId ? 'Update' : 'Add'} Team Member
            </button>
            <button type="button" class="close-modal flex-1 rounded-md border border-white/10 px-4 py-2 text-sm hover:bg-white/5">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.getElementById('modalContainer').innerHTML = modal;
  initIcons();

  if (editData) {
    document.getElementById('tmName').value = editData.name;
    document.getElementById('tmRole').value = editData.role;
    document.getElementById('tmBio').value = editData.bio;
    document.getElementById('tmOrder').value = editData.order;
    document.getElementById('tmIsCEO').checked = editData.isCEO || false;
  }

  document.getElementById('tmImage').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      const errors = await validateImage(file);
      if (errors.length > 0) {
        showToast(errors.join(', '), 'error');
        e.target.value = '';
        return;
      }
      createImagePreview(file, 'tmImagePreview');
    }
  });

  document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', () => closeModal());
  });

  document.getElementById('teamMemberForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveTeamMember(editId);
  });
}

async function saveTeamMember(editId) {
  const btn = document.querySelector('#teamMemberForm button[type="submit"]');
  setLoading(btn, true);
  
  const data = {
    name: document.getElementById('tmName').value,
    role: document.getElementById('tmRole').value,
    bio: document.getElementById('tmBio').value,
    order: parseInt(document.getElementById('tmOrder').value),
    isCEO: document.getElementById('tmIsCEO').checked,
    active: true
  };

  try {
    const imageFile = document.getElementById('tmImage').files[0];
    if (imageFile) {
      const errors = await validateImage(imageFile);
      if (errors.length > 0) throw new Error(errors.join(', '));
      
      const previewEl = document.getElementById('tmImagePreview');
      previewEl.innerHTML += createProgressBar();
      showToast('Uploading image...', 'info');
      
      const timestamp = Date.now();
      const sanitizedName = imageFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
      const path = `images/team/${timestamp}_${sanitizedName}`;
      data.imageUrl = await uploadImageWithRetry(imageFile, path);
      showToast('Image uploaded successfully!', 'success');
    } else if (editId) {
      const existingDoc = await getDoc(doc(db, 'teamMembers', editId));
      if (existingDoc.exists()) {
        data.imageUrl = existingDoc.data().imageUrl;
      } else {
        throw new Error('Original team member not found');
      }
    } else {
      throw new Error('Please select an image');
    }

    if (editId) {
      await updateDoc(doc(db, 'teamMembers', editId), { ...data, updatedAt: serverTimestamp() });
      showToast('Team member updated successfully!', 'success');
    } else {
      data.createdAt = serverTimestamp();
      await addDoc(collection(db, 'teamMembers'), data);
      showToast('Team member added successfully!', 'success');
    }

    closeModal();
    await loadTeamMembers();
  } catch (error) {
    console.error('Save error:', error);
    showToast('Error: ' + error.message, 'error');
  } finally {
    setLoading(btn, false);
  }
}

    function showHighlightModal(editId = null, editData = null) {
      const modal = `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" id="highlightModal">
          <div class="w-full max-w-lg rounded-xl border border-white/10 bg-[#0B0F19] p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold">${editId ? 'Edit' : 'Add'} Hero Highlight</h3>
              <button class="close-modal text-white/60 hover:text-white">
                <i data-lucide="x" class="h-5 w-5"></i>
              </button>
            </div>
            <form id="highlightForm" class="space-y-4">
              <div>
                <label class="block text-sm text-white/60 mb-2">Icon (Lucide name)</label>
                <input type="text" id="hIcon" required placeholder="award, check-circle, clock" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
                <p class="text-xs text-white/40 mt-1">Visit lucide.dev for icon names</p>
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Title</label>
                <input type="text" id="hTitle" required placeholder="500+ Designs Delivered" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Description</label>
                <textarea id="hDescription" required rows="2" placeholder="Professional quality every time" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white"></textarea>
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Order (1-3)</label>
                <input type="number" id="hOrder" required min="1" max="3" value="1" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div class="flex gap-3">
                <button type="submit" class="flex-1 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
                  ${editId ? 'Update' : 'Add'} Highlight
                </button>
                <button type="button" class="close-modal flex-1 rounded-md border border-white/10 px-4 py-2 text-sm hover:bg-white/5">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.getElementById('modalContainer').innerHTML = modal;
      initIcons();

      if (editData) {
        document.getElementById('hIcon').value = editData.icon;
        document.getElementById('hTitle').value = editData.title;
        document.getElementById('hDescription').value = editData.description;
        document.getElementById('hOrder').value = editData.order;
      }

      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => closeModal());
      });

      document.getElementById('highlightForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveHighlight(editId);
      });
    }

    async function saveHighlight(editId) {
      const btn = document.querySelector('#highlightForm button[type="submit"]');
      setLoading(btn, true);
      
      const data = {
        icon: document.getElementById('hIcon').value,
        title: document.getElementById('hTitle').value,
        description: document.getElementById('hDescription').value,
        order: parseInt(document.getElementById('hOrder').value),
        active: true
      };

      try {
        if (editId) {
          await updateDoc(doc(db, 'heroHighlights', editId), { ...data, updatedAt: serverTimestamp() });
          showToast('Highlight updated!', 'success');
        } else {
          // Check if we already have 3 highlights
          const snapshot = await getDocs(collection(db, 'heroHighlights'));
          if (snapshot.size >= 3) {
            showToast('Maximum 3 highlights allowed!', 'error');
            setLoading(btn, false);
            return;
          }
          
          data.createdAt = serverTimestamp();
          await addDoc(collection(db, 'heroHighlights'), data);
          showToast('Highlight added!', 'success');
        }

        closeModal();
        loadHeroHighlights();
      } catch (error) {
        console.error('Highlight save error:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  setLoading(submitBtn, true);
  
  try {
    // Get existing settings first
    const settingsDoc = await getDoc(doc(db, 'siteSettings', 'main'));
    const existingData = settingsDoc.exists() ? settingsDoc.data() : {};
    
    // Prepare update data
    const updateData = {
      contact: {
        email: document.getElementById('settingsEmail').value,
        phone: document.getElementById('settingsPhone').value,
        address: document.getElementById('settingsAddress').value,
        locationText: document.getElementById('settingsLocationText').value
      },
      social: {
        whatsapp: document.getElementById('settingsPhone').value,
        instagram: document.getElementById('settingsInstagram').value
      },
      teamSettings: {
        showJoinTeam: document.getElementById('settingsShowJoinTeam').checked
      },
      logos: existingData.logos || { main: '' },
      location: existingData.location || { imageUrl: '' },
      updatedAt: serverTimestamp()
    };

    // Handle main logo upload
    const mainLogoFile = document.getElementById('settingsLogoMain').files[0];
    if (mainLogoFile) {
      showToast('Uploading main logo...', 'info');
      const errors = await validateImage(mainLogoFile);
      if (errors.length > 0) throw new Error(errors.join(', '));
      
      const timestamp = Date.now();
      const sanitizedName = mainLogoFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
      const path = `images/logos/main_${timestamp}_${sanitizedName}`;
      updateData.logos.main = await uploadImageWithRetry(mainLogoFile, path);
      showToast('Main logo uploaded!', 'success');
    }

    // Handle location image upload
    const locationImageFile = document.getElementById('settingsLocationImage').files[0];
    if (locationImageFile) {
      showToast('Uploading location image...', 'info');
      const errors = await validateImage(locationImageFile);
      if (errors.length > 0) throw new Error(errors.join(', '));
      
      const timestamp = Date.now();
      const sanitizedName = locationImageFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
      const path = `images/location/location_${timestamp}_${sanitizedName}`;
      updateData.location.imageUrl = await uploadImageWithRetry(locationImageFile, path);
      showToast('Location image uploaded!', 'success');
    }

    // Save to Firestore - use setDoc to create if not exists
    await setDoc(doc(db, 'siteSettings', 'main'), updateData, { merge: true });
    showToast('Settings saved successfully!', 'success');
    
    // Clear file inputs
    document.getElementById('settingsLogoMain').value = '';
    document.getElementById('settingsLocationImage').value = '';
    
    // Reload settings to show new images
    await loadSettings();
    
  } catch (error) {
    console.error('Settings save error:', error);
    showToast('Error saving settings: ' + error.message, 'error');
  } finally {
    setLoading(submitBtn, false);
  }
});

    document.getElementById('addPortfolioBtn').addEventListener('click', () => showPortfolioModal());

    function showPortfolioModal(editId = null, editData = null) {
      const modal = `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" id="portfolioModal">
          <div class="w-full max-w-lg rounded-xl border border-white/10 bg-[#0B0F19] p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold">${editId ? 'Edit' : 'Add'} Portfolio Item</h3>
              <button class="close-modal text-white/60 hover:text-white">
                <i data-lucide="x" class="h-5 w-5"></i>
              </button>
            </div>
            <form id="portfolioForm" class="space-y-4">
              <div>
      <label class="block text-sm text-white/60 mb-2">Category</label>
      <input type="hidden" id="pCategory" required>
      <div id="categoryGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="birthday">
          <i data-lucide="sparkles" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Birthday</span>
        </button>
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="academic">
          <i data-lucide="book-open" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Academic</span>
        </button>
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="wedding">
          <i data-lucide="heart" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Wedding</span>
        </button>
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="business">
          <i data-lucide="megaphone" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Business</span>
        </button>
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="movie">
          <i data-lucide="clapperboard" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Movie</span>
        </button>
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="church">
          <i data-lucide="church" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Church</span>
        </button>
        <button type="button" class="category-btn rounded-lg border border-white/10 bg-white/5 p-3 hover:bg-white/10 hover:border-[#FF6B00] transition-all text-center" data-category="brand">
          <i data-lucide="asterisk" class="h-5 w-5 mx-auto mb-1 text-white/60"></i>
          <span class="text-xs text-white/80">Brand</span>
        </button>
      </div>
      <p class="text-xs text-white/40 mt-2">Click to select category</p>
    </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Title</label>
                <input type="text" id="pTitle" required class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Price</label>
                <input type="text" id="pPrice" required placeholder="₦5,000" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Description</label>
                <textarea id="pDescription" required rows="3" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white"></textarea>
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Image ${editId ? '(leave empty to keep current)' : ''}</label>
                <input type="file" id="pImage" accept="image/*" ${editId ? '' : 'required'} class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
                <p class="text-xs text-white/40 mt-1">Max 5MB, JPG/PNG/GIF</p>
                <div id="pImagePreview"></div>
              </div>
              <div class="flex gap-3">
                <button type="submit" class="flex-1 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
                  ${editId ? 'Update' : 'Add'} Item
                </button>
                <button type="button" class="close-modal flex-1 rounded-md border border-white/10 px-4 py-2 text-sm hover:bg-white/5">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.getElementById('modalContainer').innerHTML = modal;
      initIcons();
      // Category selection logic
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove selected state from all
        document.querySelectorAll('.category-btn').forEach(b => {
          b.classList.remove('bg-[#FF6B00]', 'border-[#FF6B00]');
          b.querySelector('i').classList.remove('text-white');
          b.querySelector('span').classList.remove('text-white');
        });
        
        // Add selected state to clicked button
        btn.classList.add('bg-[#FF6B00]', 'border-[#FF6B00]');
        btn.querySelector('i').classList.add('text-white');
        btn.querySelector('span').classList.add('text-white');
        
        // Set hidden input value
        document.getElementById('pCategory').value = btn.dataset.category;
      });
    });
      if (editData) {
     document.getElementById('pCategory').value = editData.category;
  
      // Pre-select category button
      document.querySelectorAll('.category-btn').forEach(btn => {
        if (btn.dataset.category === editData.category) {
          btn.classList.add('bg-[#FF6B00]', 'border-[#FF6B00]');
          btn.querySelector('i').classList.add('text-white');
          btn.querySelector('span').classList.add('text-white');
        }
      });
      
      document.getElementById('pTitle').value = editData.title;
      document.getElementById('pPrice').value = editData.price;
      document.getElementById('pDescription').value = editData.description;
    }
      document.getElementById('pImage').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          const errors = await validateImage(file);
          if (errors.length > 0) {
            showToast(errors.join(', '), 'error');
            e.target.value = '';
            return;
          }
          createImagePreview(file, 'pImagePreview');
        }
      });
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => closeModal());
      });
      document.getElementById('portfolioForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await savePortfolioItem(editId);
      });
    }

    async function savePortfolioItem(editId) {
      const btn = document.querySelector('#portfolioForm button[type="submit"]');
      setLoading(btn, true);
      const categoryNames = {
        birthday: 'Birthday Designs', academic: 'Academic Projects', wedding: 'Wedding Designs',
        business: 'Business Flyers', movie: 'Movie Posters', church: 'Church Designs', brand: 'Brand Identity'
      };
      const category = document.getElementById('pCategory').value;
      const data = {
        category, categoryDisplay: categoryNames[category],
        title: document.getElementById('pTitle').value,
        price: document.getElementById('pPrice').value,
        description: document.getElementById('pDescription').value
      };
      try {
        const imageFile = document.getElementById('pImage').files[0];
        if (imageFile) {
          const errors = await validateImage(imageFile);
          if (errors.length > 0) throw new Error(errors.join(', '));
          const previewEl = document.getElementById('pImagePreview');
          previewEl.innerHTML += createProgressBar();
          showToast('Uploading image...', 'info');
          const timestamp = Date.now();
          const sanitizedName = imageFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
          const path = `images/portfolio/${category}/${timestamp}_${sanitizedName}`;
          data.imageUrl = await uploadImageWithRetry(imageFile, path);
          showToast('Image uploaded successfully!', 'success');
        } else if (editId) {
          const existingDoc = await getDoc(doc(db, 'portfolioItems', editId));
          if (existingDoc.exists()) {
            data.imageUrl = existingDoc.data().imageUrl;
          } else {
            throw new Error('Original item not found');
          }
        } else {
          throw new Error('Please select an image');
        }
        if (editId) {
          await updateDoc(doc(db, 'portfolioItems', editId), { ...data, updatedAt: serverTimestamp() });
          showToast('Item updated successfully!', 'success');
        } else {
          const snapshot = await getDocs(collection(db, 'portfolioItems'));
          data.order = snapshot.size + 1;
          data.createdAt = serverTimestamp();
          await addDoc(collection(db, 'portfolioItems'), data);
          showToast('Item added successfully!', 'success');
        }
        closeModal();
        await loadPortfolioItems();
        await loadDashboard();
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    document.getElementById('addCarouselBtn').addEventListener('click', () => showCarouselModal());

    function showCarouselModal(editId = null, editData = null) {
      const modal = `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" id="carouselModal">
          <div class="w-full max-w-lg rounded-xl border border-white/10 bg-[#0B0F19] p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold">${editId ? 'Edit' : 'Add'} Carousel Slide</h3>
              <button class="close-modal text-white/60 hover:text-white">
                <i data-lucide="x" class="h-5 w-5"></i>
              </button>
            </div>
            <form id="carouselForm" class="space-y-4">
              <div>
                <label class="block text-sm text-white/60 mb-2">Title</label>
                <input type="text" id="cTitle" required class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Description</label>
                <textarea id="cDescription" required rows="3" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white"></textarea>
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Image ${editId ? '(leave empty to keep current)' : ''}</label>
                <input type="file" id="cImage" accept="image/*" ${editId ? '' : 'required'} class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
                <p class="text-xs text-white/40 mt-1">Max 5MB, JPG/PNG/GIF. Recommended: 1920x1080px</p>
                <div id="cImagePreview"></div>
              </div>
              <div class="flex gap-3">
                <button type="submit" class="flex-1 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
                  ${editId ? 'Update' : 'Add'} Slide
                </button>
                <button type="button" class="close-modal flex-1 rounded-md border border-white/10 px-4 py-2 text-sm hover:bg-white/5">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.getElementById('modalContainer').innerHTML = modal;
      initIcons();
      if (editData) {
        document.getElementById('cTitle').value = editData.title;
        document.getElementById('cDescription').value = editData.description;
      }
      document.getElementById('cImage').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          const errors = await validateImage(file);
          if (errors.length > 0) {
            showToast(errors.join(', '), 'error');
            e.target.value = '';
            return;
          }
          createImagePreview(file, 'cImagePreview');
        }
      });
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => closeModal());
      });
      document.getElementById('carouselForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveCarouselSlide(editId);
      });
    }

    async function saveCarouselSlide(editId) {
      const btn = document.querySelector('#carouselForm button[type="submit"]');
      setLoading(btn, true);
      const data = {
        title: document.getElementById('cTitle').value,
        description: document.getElementById('cDescription').value,
        active: true
      };
      try {
        const imageFile = document.getElementById('cImage').files[0];
        if (imageFile) {
          const errors = await validateImage(imageFile);
          if (errors.length > 0) throw new Error(errors.join(', '));
          const previewEl = document.getElementById('cImagePreview');
          previewEl.innerHTML += createProgressBar();
          showToast('Uploading image...', 'info');
          const timestamp = Date.now();
          const sanitizedName = imageFile.name.replace(/[^a-zA-Z0-9.]/g, '_');
          const path = `images/carousel/${timestamp}_${sanitizedName}`;
          data.imageUrl = await uploadImageWithRetry(imageFile, path);
          showToast('Image uploaded successfully!', 'success');
        } else if (editId) {
          const existingDoc = await getDoc(doc(db, 'carouselSlides', editId));
          if (existingDoc.exists()) {
            data.imageUrl = existingDoc.data().imageUrl;
          } else {
            throw new Error('Original slide not found');
          }
        } else {
          throw new Error('Please select an image');
        }
        if (editId) {
          await updateDoc(doc(db, 'carouselSlides', editId), { ...data, updatedAt: serverTimestamp() });
          showToast('Slide updated successfully!', 'success');
        } else {
          const snapshot = await getDocs(collection(db, 'carouselSlides'));
          data.order = snapshot.size + 1;
          data.createdAt = serverTimestamp();
          await addDoc(collection(db, 'carouselSlides'), data);
          showToast('Slide added successfully!', 'success');
        }
        closeModal();
        await loadCarouselSlides();
        await loadDashboard();
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    document.getElementById('addServiceBtn').addEventListener('click', () => showServiceModal());

                function showServiceModal(editId = null, editData = null) {
      const modal = `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" id="serviceModal">
          <div class="w-full max-w-lg rounded-xl border border-white/10 bg-[#0B0F19] p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold">${editId ? 'Edit' : 'Add'} Service</h3>
              <button class="close-modal text-white/60 hover:text-white">
                <i data-lucide="x" class="h-5 w-5"></i>
              </button>
            </div>
            <form id="serviceForm" class="space-y-4">
              <div>
                <label class="block text-sm text-white/60 mb-2">Service Name</label>
                <input type="text" id="sName" required class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Icon (Lucide name)</label>
                <input type="text" id="sIcon" required placeholder="sparkles" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
                <p class="text-xs text-white/40 mt-1">Visit lucide.dev for icon names</p>
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Price</label>
                <input type="text" id="sPrice" required placeholder="₦5,000" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
              </div>
              <div>
                <label class="block text-sm text-white/60 mb-2">Description</label>
                <textarea id="sDescription" required rows="3" class="w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white"></textarea>
              </div>
              <div class="flex gap-3">
                <button type="submit" class="flex-1 rounded-md bg-[#FF6B00] px-4 py-2 text-sm hover:bg-[#ff7b1b]">
                  ${editId ? 'Update' : 'Add'} Service
                </button>
                <button type="button" class="close-modal flex-1 rounded-md border border-white/10 px-4 py-2 text-sm hover:bg-white/5">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
      document.getElementById('modalContainer').innerHTML = modal;
      initIcons();

      if (editData) {
        document.getElementById('sName').value = editData.name;
        document.getElementById('sIcon').value = editData.icon;
        document.getElementById('sPrice').value = editData.price;
        document.getElementById('sDescription').value = editData.description;
      }

      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => closeModal());
      });

      document.getElementById('serviceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveService(editId);
      });
    }

    async function saveService(editId) {
      const btn = document.querySelector('#serviceForm button[type="submit"]');
      setLoading(btn, true);
      
      const data = {
        name: document.getElementById('sName').value,
        icon: document.getElementById('sIcon').value,
        price: document.getElementById('sPrice').value,
        description: document.getElementById('sDescription').value,
        active: true
      };

      try {
        if (editId) {
          await updateDoc(doc(db, 'services', editId), { ...data, updatedAt: serverTimestamp() });
          showToast('Service updated!', 'success');
        } else {
          const snapshot = await getDocs(collection(db, 'services'));
          data.order = snapshot.size + 1;
          data.createdAt = serverTimestamp();
          await addDoc(collection(db, 'services'), data);
          showToast('Service added!', 'success');
        }

        closeModal();
        loadServices();
        loadDashboard();
      } catch (error) {
        console.error('Service save error:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    function closeModal() {
      document.getElementById('modalContainer').innerHTML = '';
    }
  </script>
</body>
</html>